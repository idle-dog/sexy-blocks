define("widget/display",function(e,t,i){var n=function(e,t,i){this.vm=i,this.size=e||500,this.step=t||50,this.objects=[],this._dragging=0};n.CUBE_TEXTURE=THREE.ImageUtils.loadTexture("/sexy-blocks/module/widget/display/cube_texture_6b605db.png"),n.prototype.init=function(e){this.container=e,this._initCamera(),this._initControls(),this._initScene(),this._initGrid(),this._initRaycaster(),this._initLight(),this._initRender(),this._bindEvents(),this.render()},n.prototype.preview=function(){this.vm.preview=!this.vm.preview,this._rotate=Math.atan2(this.camera.position.z,this.camera.position.x),this._play()},n.prototype._play=function(){if(this.vm.preview){requestAnimationFrame(this._play.bind(this)),this._rotate-=.01;var e=this.camera.position,t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)),i=Math.cos(this._rotate)*t,n=Math.sin(this._rotate)*t,s=e.y;e.set(i,s,n),this.camera.lookAt(new THREE.Vector3),this.render()}},n.prototype._initCamera=function(){this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,1e4),this.camera.position.set(500,800,1300),this.camera.lookAt(new THREE.Vector3)},n.prototype._initControls=function(){this.controls=new THREE.OrbitControls(this.camera),this.controls.target.set(0,0,0),this.controls.update()},n.prototype._initScene=function(){this.scene=new THREE.Scene},n.prototype._initGrid=function(){for(var e=this.size,t=this.step,i=new THREE.Geometry,n=-e;e>=n;n+=t)i.vertices.push(new THREE.Vector3(-e,0,n)),i.vertices.push(new THREE.Vector3(e,0,n)),i.vertices.push(new THREE.Vector3(n,0,-e)),i.vertices.push(new THREE.Vector3(n,0,e));var s=new THREE.LineBasicMaterial({color:0,opacity:.2,transparent:!0}),o=new THREE.LineSegments(i,s);this.scene.add(o)},n.prototype._initRaycaster=function(){this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2;var e=new THREE.PlaneBufferGeometry(1e3,1e3);e.rotateX(-Math.PI/2),this.plane=new THREE.Mesh(e,new THREE.MeshBasicMaterial({visible:!1})),this.scene.add(this.plane),this.objects.push(this.plane)},n.prototype._initLight=function(){var e=new THREE.AmbientLight(16777215);this.scene.add(e)},n.prototype._initRender=function(){this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setClearColor(15790320),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.container.appendChild(this.renderer.domElement)},n.prototype.render=function(){this.renderer.render(this.scene,this.camera)},n.prototype._bind=function(e,t,i,n){return e.addEventListener(t,function(e){e.preventDefault(),n&&this.vm.preview||(i.call(this,e),this.render())}.bind(this),!1)},n.prototype._bindEvents=function(){var e=new Function;this._bind(window,"resize",this._onWindowResize),this._bind(this.container,"mousewheel",e),this._bind(this.container,"touchstart",this._onTouchStart,!0),this._bind(this.container,"touchmove",this._onTouchMove,!0),this._bind(this.container,"touchend",this._onTouchEnd,!0)},n.prototype._onWindowResize=function(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)},n.prototype._onTouchEnd=function(e){if(0===e.touches.length&&this._dragging<3){var t=e.changedTouches[0];this._click(t.clientX,t.clientY)}},n.prototype._click=function(e,t){var i=this._getIntersect(e,t);i&&(this.vm.earse?this._delCube(i):this._addCube(i))},n.prototype._onTouchMove=function(){this._dragging++},n.prototype._onTouchStart=function(e){1===e.touches.length&&(this._dragging=0)},n.prototype._getIntersect=function(e,t){this.mouse.set(e/window.innerWidth*2-1,2*-(t/window.innerHeight)+1),this.raycaster.setFromCamera(this.mouse,this.camera);var i=this.raycaster.intersectObjects(this.objects);return i.length>0?i[0]:void 0},n.prototype._addCube=function(e){if(e){var t=new THREE.BoxGeometry(this.step,this.step,this.step),i=new THREE.MeshLambertMaterial({color:this.vm.color,map:n.CUBE_TEXTURE}),s=new THREE.Mesh(t,i),o=s.position;if(o.copy(e.point).add(e.face.normal),o.divideScalar(50).floor().multiplyScalar(50).addScalar(25),o.y<0||o.y>this.size||o.x>this.size||o.z>this.size||o.z<-this.size||o.x<-this.size)return;this.scene.add(s),this.objects.push(s)}},n.prototype._delCube=function(e){e&&e.object!=this.plane&&(this.scene.remove(e.object),this.objects.splice(this.objects.indexOf(e.object),1))},i.exports=Vue.extend({template:'<div class="w-display">\n    <div class="w-display_viewer"></div>\n    <div class="w-display_toolbar" :class="{ \'w-display_toolbar_preview\': preview }">\n        <div class="w-display_btn w-display_del"\n             :class="{ \'w-display_btn-del_on\': earse }"\n             @click="onToggleEarseMode">\n            <i class="iconfont icon-delete"></i>\n        </div>\n        <div class="w-display_btn w-display_color"\n             :class="{ \'w-display_color_pick\': pick }"\n             @click="onTogglePickMode">\n            <i class="iconfont icon-box-solid" :style="{ color: color }"></i>\n            <div class="w-display_colors">\n                <div class="w-display_c" v-for="c in colors" @click="onPick(c.value)">\n                    <i class="iconfont icon-box-solid" :style="{ color: c.value }"></i>\n                </div>\n            </div>\n        </div>\n        <div class="w-display_btn w-display_share" @click="onShare">\n            <i class="iconfont icon-share"></i>\n        </div>\n        <div class="w-display_btn w-display_play"\n            @click="onTogglePreviewMode">\n            <i class="iconfont" :class="{ \'icon-play\': !preview, \'icon-pause\': preview }"></i>\n        </div>\n    </div>\n</div>',data:function(){return{color:"#f00",earse:!1,preview:!1,pick:!1,colors:[{value:"#f00",text:"红色"},{value:"#0f0",text:"绿色"},{value:"#00f",text:"蓝色"},{value:"#ff0",text:"黄色"},{value:"#f0f",text:"紫色"},{value:"#0ff",text:"青色"},{value:"#fff",text:"白色"},{value:"#000",text:"黑色"}]}},ready:function(){!Detector.webgl,this.display=new n(500,50,this),this.display.init(this.$el.querySelector(".w-display_viewer"))},methods:{onToggleEarseMode:function(){this.earse=!this.earse},onTogglePreviewMode:function(){this.display.preview()},onTogglePickMode:function(){this.pick=!this.pick},onShare:function(){alert("敬请期待!")},onPick:function(e){this.color=e}}})});